---
// src/pages/dashboard.astro
import Layout from '../layouts/Layout.astro';
---
<Layout title="Dashboard de Cliente">
    <div id="auth-container">
        <main class="dashboard-page" style="display: none;">
            <div class="dashboard-header">
                <h1>Bienvenido a tu Dashboard</h1>
                <button id="logout-btn" class="btn btn--secondary">Cerrar Sesión</button>
            </div>
    
            <section id="projects-section">
                <h2>Mis Proyectos</h2>
                <div id="projects-list">
                    <!-- Los proyectos se cargarán aquí desde Firestore -->
                    <p>Cargando proyectos...</p>
                </div>
            </section>
    
            <section id="testimonials-section">
                <h2>Mis Testimonios</h2>
                <div id="testimonials-list">
                    <!-- Los testimonios se cargaron aquí -->
                    <p>Cargando testimonios...</p>
                </div>
            </section>
        </main>
        <div id="loading-indicator" style="text-align: center; padding: 2rem;">
            <p>Verificando autenticación...</p>
        </div>
    </div>
</Layout>

<script is:inline>
    import { auth } from '../firebase/client';
    import { onAuthStateChanged, signOut } from "firebase/auth";

    const mainContent = document.querySelector('.dashboard-page');
    const loadingIndicator = document.getElementById('loading-indicator');
    const logoutBtn = document.getElementById('logout-btn');

    const unsubscribe = onAuthStateChanged(auth, (user) => {
        if (user) {
            // Usuario está logueado, mostramos el contenido
            loadingIndicator.style.display = 'none';
            mainContent.style.display = 'block';
        } else {
            // Usuario no está logueado, redirigir a la página de login
            window.location.href = '/admin';
        }
    });

    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                // El listener onAuthStateChanged se encargará de la redirección
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                alert('Hubo un error al cerrar sesión.');
            }
        });
    }

    // Limpiamos el listener cuando el usuario navega fuera de la página
    window.addEventListener('beforeunload', () => {
        unsubscribe();
    });
</script>
